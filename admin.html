<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shoppizzy Admin</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; color: #111827; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    header { background: #111827; padding: 20px 0; }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 20px; font-weight: 800; color: #fff; text-decoration: none; }
    .admin-badge { background: #dc2626; color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
    .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }
    .login-card { background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 40px; width: 100%; max-width: 400px; }
    .login-card h2 { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
    .login-card p { color: #6b7280; margin-bottom: 32px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
    .form-group input { width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; font-family: inherit; }
    .form-group input:focus { outline: none; border-color: #2563eb; }
    .btn { width: 100%; padding: 14px; background: #2563eb; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit; }
    .btn:hover { background: #1d4ed8; }
    .alert { padding: 14px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; font-weight: 600; }
    .alert-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .dashboard { padding: 40px 0; }
    .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); text-align: center; }
    .stat-card .stat-value { font-size: 32px; font-weight: 800; color: #2563eb; }
    .stat-card .stat-label { font-size: 13px; color: #6b7280; font-weight: 600; margin-top: 4px; }
    .tabs { display: flex; margin-bottom: 32px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: #fff; }
    .tab { flex: 1; padding: 14px; background: #fff; border: none; font-weight: 600; font-size: 15px; cursor: pointer; color: #6b7280; transition: all 0.2s; font-family: inherit; }
    .tab.active { background: #2563eb; color: #fff; }
    .panel { display: none; }
    .panel.active { display: block; }
    .product-list { display: flex; flex-direction: column; gap: 16px; }
    .product-item { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 24px; display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
    .product-item img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
    .product-item .no-img { width: 100px; height: 100px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0; }
    .product-info { flex: 1; min-width: 200px; }
    .product-info h4 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .product-info p { color: #6b7280; font-size: 14px; margin-bottom: 4px; }
    .product-info .price { font-size: 20px; font-weight: 800; color: #2563eb; margin: 8px 0; }
    .product-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .btn-approve { padding: 10px 20px; background: #16a34a; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; }
    .btn-approve:hover { background: #15803d; }
    .btn-reject { padding: 10px 20px; background: #dc2626; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; }
    .btn-reject:hover { background: #b91c1c; }
    .seller-list { display: flex; flex-direction: column; gap: 16px; }
    .seller-item { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
    .seller-info h4 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .seller-info p { color: #6b7280; font-size: 14px; }
    .seller-actions { display: flex; gap: 12px; }
    .btn-suspend { padding: 10px 20px; background: #f97316; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; }
    .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; background: #fff; border-radius: 12px; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-card { background: #fff; border-radius: 16px; padding: 32px; width: 100%; max-width: 400px; margin: 20px; }
    .modal-card h3 { font-size: 20px; font-weight: 800; margin-bottom: 16px; }
    .modal-card textarea { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 14px; height: 100px; resize: vertical; margin-bottom: 16px; }
    .modal-buttons { display: flex; gap: 12px; }
    .btn-cancel { flex: 1; padding: 12px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: inherit; }
    .btn-confirm-reject { flex: 1; padding: 12px; background: #dc2626; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: inherit; }
    .logout-btn { padding: 8px 16px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 14px; }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <a href="/" class="logo">üõçÔ∏è Shoppizzy Admin</a>
      <div style="display:flex;gap:12px;align-items:center;">
        <span class="admin-badge">ADMIN</span>
        <button class="logout-btn" onclick="adminLogout()" id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <!-- Login -->
  <div class="login-wrapper" id="loginWrapper">
    <div class="login-card">
      <h2>Admin Login</h2>
      <p>Enter your admin secret to access the dashboard</p>
      <div id="loginAlert" class="alert alert-error" style="display:none;"></div>
      <div class="form-group">
        <label>Admin Secret</label>
        <input type="password" id="adminSecret" placeholder="Enter admin secret" onkeydown="if(event.key==='Enter')adminLogin()">
      </div>
      <button class="btn" onclick="adminLogin()">Login to Admin</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard container" id="adminDashboard" style="display:none;">
    <div class="stats-bar">
      <div class="stat-card"><div class="stat-value" id="statPending">0</div><div class="stat-label">Pending Products</div></div>
      <div class="stat-card"><div class="stat-value" id="statSellers">0</div><div class="stat-label">Total Sellers</div></div>
      <div class="stat-card"><div class="stat-value" id="statApproved">0</div><div class="stat-label">Active Sellers</div></div>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="showTab('pending', event)">üìã Pending Products</button>
      <button class="tab" onclick="showTab('sellers', event)">üë• All Sellers</button>
    </div>
    <!-- Pending Products -->
    <div class="panel active" id="panel-pending">
      <div id="pendingLoading" style="text-align:center;padding:40px;color:#6b7280;">Loading...</div>
      <div class="product-list" id="pendingList" style="display:none;"></div>
      <div id="pendingEmpty" class="empty-state" style="display:none;"><div class="icon">‚úÖ</div><p>No products pending review!</p></div>
    </div>
    <!-- Sellers -->
    <div class="panel" id="panel-sellers">
      <div id="sellersLoading" style="text-align:center;padding:40px;color:#6b7280;">Loading...</div>
      <div class="seller-list" id="sellersList" style="display:none;"></div>
      <div id="sellersEmpty" class="empty-state" style="display:none;"><div class="icon">üë•</div><p>No sellers yet!</p></div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div class="modal" id="rejectModal">
    <div class="modal-card">
      <h3>Reject Product</h3>
      <textarea id="rejectReason" placeholder="Reason for rejection (shown to seller)..."></textarea>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="btn-confirm-reject" onclick="confirmReject()">Reject Product</button>
      </div>
    </div>
  </div>

  <script>
    let adminSecret = '';
    let rejectProductId = '';

    function adminLogin() {
      const secret = document.getElementById('adminSecret').value.trim();
      if (!secret) {
        document.getElementById('loginAlert').textContent = 'Please enter your admin secret.';
        document.getElementById('loginAlert').style.display = 'block';
        return;
      }
      adminSecret = secret;
      document.getElementById('loginWrapper').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'block';
      document.getElementById('logoutBtn').style.display = 'block';
      loadPendingProducts();
      loadSellers();
    }

    function adminLogout() {
      adminSecret = '';
      document.getElementById('loginWrapper').style.display = 'flex';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('adminSecret').value = '';
    }

    function showTab(tab, e) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById('panel-' + tab).classList.add('active');
      if (e && e.target) e.target.classList.add('active');
      if (tab === 'sellers') loadSellers();
    }

    async function loadPendingProducts() {
      try {
        const res = await fetch('/api/admin/pending-products', {
          headers: { 'Authorization': 'Bearer ' + adminSecret }
        });
        const data = await res.json();
        if (!res.ok) { adminLogout(); return; }

        const products = data.products || [];
        document.getElementById('statPending').textContent = products.length;
        document.getElementById('pendingLoading').style.display = 'none';

        if (products.length === 0) {
          document.getElementById('pendingEmpty').style.display = 'block';
          return;
        }

        const list = document.getElementById('pendingList');
        list.innerHTML = products.map(p => {
          const images = JSON.parse(p.image_urls || '[]');
          const imgHtml = images.length > 0
            ? '<img src="' + images[0] + '" alt="' + p.title + '">'
            : '<div class="no-img">üì¶</div>';
          return '<div class="product-item" id="product-' + p.id + '">' +
            imgHtml +
            '<div class="product-info">' +
              '<h4>' + p.title + '</h4>' +
              '<div class="price">$' + parseFloat(p.price).toFixed(2) + '</div>' +
              '<p>üè™ ' + p.shop_name + ' (' + p.seller_email + ')</p>' +
              '<p>üì¶ ' + p.category + ' ¬∑ ‚öñÔ∏è ' + (p.weight_grams || 227) + 'g</p>' +
              '<p style="margin-top:8px;color:#374151;">' + p.description.substring(0, 150) + (p.description.length > 150 ? '...' : '') + '</p>' +
            '</div>' +
            '<div class="product-actions">' +
              '<button class="btn-approve" onclick="approveProduct(\'' + p.id + '\')">‚úÖ Approve</button>' +
              '<button class="btn-reject" onclick="openRejectModal(\'' + p.id + '\')">‚ùå Reject</button>' +
            '</div>' +
          '</div>';
        }).join('');
        list.style.display = 'flex';
      } catch (err) {
        document.getElementById('pendingLoading').textContent = 'Error loading products.';
      }
    }

    async function loadSellers() {
      document.getElementById('sellersLoading').style.display = 'block';
      document.getElementById('sellersList').style.display = 'none';
      document.getElementById('sellersEmpty').style.display = 'none';

      try {
        const res = await fetch('/api/admin/sellers', {
          headers: { 'Authorization': 'Bearer ' + adminSecret }
        });
        const data = await res.json();
        const sellers = data.sellers || [];

        document.getElementById('statSellers').textContent = sellers.length;
        document.getElementById('statApproved').textContent = sellers.filter(s => s.status === 'active').length;
        document.getElementById('sellersLoading').style.display = 'none';

        if (sellers.length === 0) {
          document.getElementById('sellersEmpty').style.display = 'block';
          return;
        }

        const list = document.getElementById('sellersList');
        list.innerHTML = sellers.map(s => {
          const approved = s.is_permanently_approved
            ? '‚≠ê Permanently Approved'
            : (s.approved_until > Date.now() ? '‚úÖ Active (90-day)' : '‚ö†Ô∏è Needs Review');
          return '<div class="seller-item">' +
            '<div class="seller-info">' +
              '<h4>' + s.shop_name + '</h4>' +
              '<p>üìß ' + s.email + ' ¬∑ Status: ' + s.status + '</p>' +
              '<p>' + approved + '</p>' +
            '</div>' +
            '<div class="seller-actions">' +
              (!s.is_permanently_approved ? '<button class="btn-approve" onclick="approveSeller(\'' + s.id + '\')">‚≠ê Approve Permanently</button>' : '') +
              '<button class="btn-suspend" onclick="suspendSeller(\'' + s.id + '\')">üö´ Suspend</button>' +
            '</div>' +
          '</div>';
        }).join('');
        list.style.display = 'flex';
      } catch (err) {
        document.getElementById('sellersLoading').textContent = 'Error loading sellers.';
      }
    }

    async function approveProduct(productId) {
      try {
        const res = await fetch('/api/admin/approve-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + adminSecret },
          body: JSON.stringify({ product_id: productId })
        });
        if (res.ok) {
          document.getElementById('product-' + productId)?.remove();
          const remaining = document.querySelectorAll('[id^="product-"]').length;
          document.getElementById('statPending').textContent = remaining;
          if (remaining === 0) {
            document.getElementById('pendingEmpty').style.display = 'block';
            document.getElementById('pendingList').style.display = 'none';
          }
          alert('‚úÖ Product approved and now live!');
        }
      } catch (err) { alert('Error approving product.'); }
    }

    function openRejectModal(productId) {
      rejectProductId = productId;
      document.getElementById('rejectReason').value = '';
      document.getElementById('rejectModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('rejectModal').classList.remove('active');
      rejectProductId = '';
    }

    async function confirmReject() {
      const reason = document.getElementById('rejectReason').value.trim();
      if (!reason) { alert('Please provide a rejection reason.'); return; }
      try {
        const res = await fetch('/api/admin/reject-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + adminSecret },
          body: JSON.stringify({ product_id: rejectProductId, reason })
        });
        if (res.ok) {
          document.getElementById('product-' + rejectProductId)?.remove();
          const remaining = document.querySelectorAll('[id^="product-"]').length;
          document.getElementById('statPending').textContent = remaining;
          if (remaining === 0) {
            document.getElementById('pendingEmpty').style.display = 'block';
            document.getElementById('pendingList').style.display = 'none';
          }
          closeModal();
          alert('Product rejected.');
        }
      } catch (err) { alert('Error rejecting product.'); }
    }

    async function approveSeller(sellerId) {
      if (!confirm('Permanently approve this seller?')) return;
      try {
        const res = await fetch('/api/admin/approve-seller', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + adminSecret },
          body: JSON.stringify({ seller_id: sellerId })
        });
        if (res.ok) { alert('‚úÖ Seller permanently approved!'); loadSellers(); }
      } catch (err) { alert('Error approving seller.'); }
    }

    async function suspendSeller(sellerId) {
      if (!confirm('Suspend this seller? They will not be able to login.')) return;
      try {
        const res = await fetch('/api/admin/suspend-seller', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + adminSecret },
          body: JSON.stringify({ seller_id: sellerId })
        });
        if (res.ok) { alert('Seller suspended.'); loadSellers(); }
      } catch (err) { alert('Error suspending seller.'); }
    }
  </script>
</body>
</html>
